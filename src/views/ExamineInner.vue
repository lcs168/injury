<template>
    <div style="height: 100%;margin-top:0.5% ;">
    <div style="color: #036eff;font-size: 2.5vh;">
    <span style="margin-left: 2%;">è®­ç»ƒæ¨¡å¼</span>
    <span style="float: right;margin-right: 2%;">å‰©ä½™æ—¶é—´ï¼š 120åˆ†é’Ÿ</span>
    <el-divider style="margin: 0;"/>
    </div>
    <div style="display: inline-block;height: 100%;margin-left: 2%;margin-top: 0.8%;">
    <span style="color: #036eff;">0/10é¢˜</span>
    <ul class="ulStyle">
        <!-- <li v-for="(item,index) in options" :class='{isActive:index==isactive}' @click="selected(index)" :key="item">{{ item }}</li> -->
        <li v-for="(item,index) in options" :id="'index'+(index+1)" :class='{isActive:index==isactive}' @click="selected(index)" :key="item">{{ item }}</li>
    </ul>
    </div>
    <div style="display: inline-block;float: right;border-left: 2px solid #dcdfe6;width: 92%;height: 100%;">
        <div id="rightSel" style="margin-left: 10%;margin-top: 1%;">
            <span style="font-size: 3vh;">åˆ¤æ–­é¢˜</span>
            <div style="display: flex;font-size: 1.8vh;align-items: center;">
            <el-divider style="margin: 0;border-width: 3px;border-color: black;" direction="vertical" />
            <span style="margin-left: 0.5%;">è¾¨åˆ«ä¸‹å›¾ä¼¤æƒ…</span>
            </div>

            <div>
            <el-image class="imgTwo" :src="require('@/assets/imagebox/burn/1.jpg')" alt="" style="height: 60vh;width: 90%;" />
            </div>

            
            <span id="determine" :class='{acTived:show==false}' :v-model="msg" v-on:click="sendVoice()" style="display: block;font-size: 4vh;cursor: pointer;color: #036eff;border-radius: 10px;margin-top: 2vh;width: 90%;height: 8vh;border: 2px solid #dcdfe6;">
            <img v-show="show" style="width: 5vh;position: relative;top:1vh;left: 1vh;" src="../assets/icon/è¯­éŸ³.png" alt=""/>
            <img v-show="!show" style="width: 5vh;position: relative;top:1vh;left: 1vh;" src="../assets/icon/æ’­æ”¾ä¸­.png" alt=""/>
            <template v-if="show">
                <span class="msg">{{ msg }}</span>
            </template>
            <template v-else>
                <span class="msg">{{ afterMsg }}</span>
            </template>
            </span>
            <div :class="{isShow:showValue==true}" style="margin-top: 2vh;width: 90%;display: flex;align-items: center;">
                <div style="display: inline-block;">
                    <el-image :class="{isshow:isTrue==true}" style="height: 5vh;" :src="require('@/assets/icon/æ­£ç¡®.png')" alt=""/>
                    <el-image :class="{isshow:isfalse==true}" style="height: 5vh;" :src="require('@/assets/icon/é”™è¯¯.png')" alt=""/>
                </div>
                <div v-show="value" style="display: inline-block;margin-left:1%;height: 5vh;font-size: 3vh;color: #036eff;">{{ answer }}</div>
            </div>


            <!-- <el-button @click="playVedio()" type="primary">ç‚¹å‡»æŸ¥çœ‹æ“ä½œè§†é¢‘</el-button> -->

            <div style="display: flex;margin-top: 1%;font-size: 1.8vh;align-items: center;">
            <el-divider style="margin: 0;border-width: 3px;border-color: black;" direction="vertical" />
            <span style="margin-left: 0.5%;">è¯·é€‰æ‹©æ­£ç¡®çš„æ•‘æ²»æ–¹æ¡ˆ</span>
            </div>
            <div style="width: 90%;">
                <el-row style="">
                    <el-col style="margin-right: 2%;margin-top: 2%;" v-for="(image,index) in imagebox" :key="index" :span="8" :index="index" @click="selecte(index)">
                        <el-card>
                            <el-image class="imgOne" :src="image" alt="" style="display: flex;height: 25vh;" />
                        </el-card>
                    </el-col>
                </el-row>
            </div>
            <div style="display: flex;">

                
            <!-- <div style="width: 30%;">
            <span :class='{acTived:show==false}' :v-model="msg" v-on:click="startRecord()" style="display: block;font-size: 3vh;cursor: pointer;color: #036eff;border-radius: 10px;margin-top: 2vh;width: 100%;height: 8vh;border: 2px solid #dcdfe6;">
            <img v-show="show" style="width: 5vh;position: relative;top:1vh;" src="../assets/icon/è¯­éŸ³.png" alt=""/>
            <img v-show="!show" style="width: 5vh;position: relative;top:1vh;left: 1vh;" src="../assets/icon/æ’­æ”¾ä¸­.png" alt=""/> -->
            <!-- {{ msg }} -->
            <!-- <template v-if="show">
                <span class="msg">{{ voiceMsg }}</span>
            </template>
            <template v-else>
                <span class="msg">{{ afterMsg }}</span>
            </template>
            </span>
            <span>
                <el-button type="primary" @click="stopRecord()">åœæ­¢å½•éŸ³</el-button>
            </span>
            </div> -->
            
            <div  style="width: 30%;">
            <span  id="select" :class='{acTivedTwo:showTwo==false}' :v-model="msg" v-on:click="sendVoiceTwo()" style="display: block;font-size: 3vh;cursor: pointer;color: #036eff;border-radius: 10px;margin-top: 2vh;width: 100%;height: 8vh;border: 2px solid #dcdfe6;">
            <img v-show="showTwo" style="width: 5vh;position: relative;top:1vh;" src="../assets/icon/è¯­éŸ³.png" alt=""/>
            <img v-show="!showTwo" style="width: 5vh;position: relative;top:1vh;left: 1vh;" src="../assets/icon/æ’­æ”¾ä¸­.png" alt=""/>
            <!-- {{ msg }} -->
            <template v-if="showTwo">
                <span class="msg">{{ voiceMsgTwo }}</span>
            </template>
            <template v-else>
                <span class="msg">{{ afterMsgTwo }}</span>
            </template>
            </span>
            <!-- <span>
                <el-button type="primary" @click="stopRecord()">åœæ­¢å½•éŸ³</el-button>
            </span> -->
            </div>


            <div style="margin-left: 20%;display:grid;width: 30%;">
            <span :class='{showIcon:show==false}' :v-model="msg" v-on:click="dialogVisible = true,initCamera()" style="display: flex;align-items: center;font-size: 3vh;cursor: pointer;color: #036eff;border-radius: 10px;margin-top: 2vh;width: 100%;height: 8vh;border: 2px solid #dcdfe6;">
            <el-icon size="40"><CameraFilled /></el-icon>
            <span class="msg">{{ photoMsg }}</span>
            </span>
            </div>
        </div>
            <div :class="{isShow:showValueTwo==true}" style="margin-top: 2vh;width: 90%;display: flex;align-items: center;">
                <div style="display: inline-block;">
                    <el-image :class="{isshow:isTrueTwo==true}" style="height: 5vh;" :src="require('@/assets/icon/æ­£ç¡®.png')" alt=""/>
                    <el-image :class="{isshow:isfalseTwo==true}" style="height: 5vh;" :src="require('@/assets/icon/é”™è¯¯.png')" alt=""/>
                </div>
                <div v-show="valueTwo" style="display: inline-block;margin-left:1%;height: 5vh;font-size: 3vh;color: #036eff;">{{ answer }}</div>
            </div>


            <div>
            <div :class='{isShowVedio:showvedio==true}'>
                <span style="font-size: 2.5vh;">å¦‚ä½•è¾¨åˆ«çƒ§ä¼¤ï¼Ÿ</span>
                <div style="display: flex;margin-top: 1%;font-size: 1.8vh;align-items: center;">
                <el-divider style="margin: 0;border-width: 3px;border-color: black;" direction="vertical" />
                <span style="margin-left: 0.5%;">è¯·é€‰æ‹©æ­£ç¡®çš„æ•‘æ²»æ–¹æ¡ˆ</span>
                </div>
                
                <video ref="videoPlayer" controls style="width: 90%;height: 88%;">
                <source :src="videourl" type="video/mp4">
                </video>

            </div>
            </div>
        </div>
    
    </div>


    <el-dialog
    v-model="dialogVisible"
    title="Tipsï¼šè¯·å…è®¸è®¿é—®æ‘„åƒå¤´æƒé™è¿›è¡Œæ‹ç…§"
    width="40%"
  > 
    <div style="width: 90%;margin-left: 10%;">

    <video id="videoCamera" style="width: 100%;padding: 3%;border-radius: 5%;border: 1px solid #036eff;" ref="videoElement" autoplay></video>
    


      <el-button type="primary" @click="takePhoto()" style="width: 100%;height: 20%;">æ‹ç…§</el-button>
      <canvas style="width: 100%; height: 40vh;"
      ref="canvasElement"></canvas>
      <!-- <img :src="photoUrl" v-if="photoUrl" alt="æ‹æ‘„ç…§ç‰‡"> -->
    </div>
    <template #footer>
      <span class="dialog-footer">
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="dialogVisible = false,sendPhoto()">
          æäº¤
        </el-button>
      </span>
    </template>
  </el-dialog>



    </div>
</template>


<script>
import Record from "../common/record-sdk";
import { ref } from 'vue'
import {sendPhoto} from '@/api/api'
// import Vedio from '@/components/Vedio.vue';
export default {
    name:"ExamineInner",
    data(){
        return {
            isactive:'0',
            show:true,
            showTwo:true,
            showValue:true,
            showValueTwo:true,
            isTrue:true,
            isfalse:true,
            isTrueTwo:true,
            isfalseTwo:true,
            value:false,
            valueTwo:false,
            showvedio:true,
            selectedNo:["1","2","3","4"],
            options:["1","2","3","4","5","6","7","8","9","10"],
            voiceMsg:"è¯·ç‚¹å‡»ä½¿ç”¨è¯­éŸ³è¿›è¡Œå›ç­”",
            voiceMsgTwo:"è¯·ç‚¹å‡»ä½¿ç”¨è¯­éŸ³è¿›è¡Œå›ç­”",
            photoMsg:"è¯·ç‚¹å‡»æ‹æ‘„æ‰‹åŠ¿å›ç­”",
            beforeMsg1:"è¯·é€‰æ‹©æ­£ç¡®çš„æ•‘æ²»æ–¹æ¡ˆæˆ–è¯­éŸ³è¾“å…¥ ğŸ”Š",
            afterMsg:"  è¿™ä¸ªæ˜¯çƒ§ä¼¤",
            afterMsgTwo:"  è¿™é“é¢˜é€‰å›¾1",
            answer:"å›ç­”æ­£ç¡®",
            dialogVisible:ref(false),
            photoUrl: null,
            thisVideo:null,
            isFinished: false,
			audio: "",
			recorder: new Record(),
            videourl:"/videos/åˆ’ä¼¤æ•‘æ²».mp4",
            imagebox:[
            require('@/assets/imagebox/burn/1.jpg'),
            require('@/assets/imagebox/bruise/2.jpg'),
            require('@/assets/imagebox/burn/3.jpg'),
            require('@/assets/imagebox/gunshot/2.jpg'),
            ],

        }
    },
    components:{
        // Vedio,
    },

    methods:{
        selected(index){
            console.log(index);
            this.isactive = index;
            const target = document.getElementById('rightSel');
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
            this.show=true
            this.showValue=!this.showValue
            this.isTrue=true
            this.value=false
            // -------------
            this.showTwo=true
            this.showValueTwo=!this.showValueTwo
            this.isTrueTwo=true
            this.valueTwo=false
        },
        sendVoice(){
            console.log("å‘é€äº†ä¸€æ®µè¯­éŸ³")
            this.show = !this.show
            console.log("+++"+this.showValue)
            this.showValue=!this.showValue
            this.isTrue=false
            this.value=true
        },
        sendVoiceTwo(){
            console.log("å‘é€äº†ä¸€æ®µè¯­éŸ³")
            this.showTwo = !this.showTwo
            console.log("+++"+this.showValueTwo)
            this.showValueTwo=!this.showValueTwo
            this.isTrueTwo=false
            this.valueTwo=true
        },
        sendPhoto(){
            const canvasElement = this.$refs.canvasElement;

            // è·å–Canvasä¸­çš„å›¾åƒæ•°æ®
            const imageData = canvasElement.toDataURL('image/png');

            // // æ˜¾ç¤ºæ‹æ‘„çš„ç…§ç‰‡
            // this.photoUrl = imageData;

            const file = imageData
            const time = (new Date()).valueOf()
            // const name = time + '.png'
            const name = time
            console.log("name"+name)
            console.log("file+++"+file)
            const conversions = this.base64ToFile(file, name)
            const data = new FormData()

            console.log()
            data.append('file', conversions)
            
            sendPhoto(data).then(res=>{
                if(res.code==='200'){
                    console.log("æˆåŠŸäº†")
                    this.$message.success("æäº¤æˆåŠŸ")
                    this.value=true
                    this.isTrue=false
                    
                }else{
                    this.$message.success("å›¾ç‰‡æœªèƒ½è¯†åˆ«,è¯·é‡æ–°æ‹ç…§æäº¤")
                    console.log("å›¾ç‰‡æœªèƒ½è¯†åˆ«")
                }
                this.stopNavigator()
            })
        },
        selecte(index){
            console.log("é€‰æ‹©äº†ç¬¬"+index+"ä¸ª")
        },
        playVedio(){
            this.showvedio=false
            this.$message.success("è¯·ç¿»åˆ°åº•éƒ¨æŸ¥çœ‹æ“ä½œè§†é¢‘")
        },
      initCamera() {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            const videoElement = this.$refs.videoElement;
            videoElement.srcObject = stream;
            videoElement.play();
          })
          .catch(error => {
            console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š', error);
            this.$message.error("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š")
          });
      },
        takePhoto() {
        const videoElement = this.$refs.videoElement;
        const canvasElement = this.$refs.canvasElement;
        const context = canvasElement.getContext('2d');

        // å°†è§†é¢‘æµçš„ç”»é¢ç»˜åˆ¶åˆ°Canvasä¸­
        context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
        
        },
        // base64å›¾ç‰‡è½¬fileçš„æ–¹æ³•ï¼ˆbase64å›¾ç‰‡, è®¾ç½®ç”Ÿæˆfileçš„æ–‡ä»¶åï¼‰
        base64ToFile(base64, fileName) {
        // å°†base64æŒ‰ç…§ , è¿›è¡Œåˆ†å‰² å°†å‰ç¼€  ä¸åç»­å†…å®¹åˆ†éš”å¼€
        const data = base64.split(',')
        // åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼ ä»å‰ç¼€ä¸­è·å–å›¾ç‰‡çš„ç±»å‹ä¿¡æ¯ï¼ˆimage/pngã€image/jpegã€image/webpç­‰ï¼‰
        const type = data[0].match(/:(.*?);/)[1]
        // ä»å›¾ç‰‡çš„ç±»å‹ä¿¡æ¯ä¸­ è·å–å…·ä½“çš„æ–‡ä»¶æ ¼å¼åç¼€ï¼ˆpngã€jpegã€webpï¼‰
        const suffix = type.split('/')[1]
        // ä½¿ç”¨atob()å¯¹base64æ•°æ®è¿›è¡Œè§£ç   ç»“æœæ˜¯ä¸€ä¸ªæ–‡ä»¶æ•°æ®æµ ä»¥å­—ç¬¦ä¸²çš„æ ¼å¼è¾“å‡º
        const bstr = window.atob(data[1])
        // è·å–è§£ç ç»“æœå­—ç¬¦ä¸²çš„é•¿åº¦
        let n = bstr.length
        // æ ¹æ®è§£ç ç»“æœå­—ç¬¦ä¸²çš„é•¿åº¦åˆ›å»ºä¸€ä¸ªç­‰é•¿çš„æ•´å½¢æ•°å­—æ•°ç»„
        // ä½†åœ¨åˆ›å»ºæ—¶ æ‰€æœ‰å…ƒç´ åˆå§‹å€¼éƒ½ä¸º 0
        const u8arr = new Uint8Array(n)
        // å°†æ•´å½¢æ•°ç»„çš„æ¯ä¸ªå…ƒç´ å¡«å……ä¸ºè§£ç ç»“æœå­—ç¬¦ä¸²å¯¹åº”ä½ç½®å­—ç¬¦çš„UTF-16 ç¼–ç å•å…ƒ
        while (n--) {
            // charCodeAt()ï¼šè·å–ç»™å®šç´¢å¼•å¤„å­—ç¬¦å¯¹åº”çš„ UTF-16 ä»£ç å•å…ƒ
            u8arr[n] = bstr.charCodeAt(n)
        }
        // åˆ©ç”¨æ„é€ å‡½æ•°åˆ›å»ºFileæ–‡ä»¶å¯¹è±¡
        // new File(bits, name, options)
        const file = new File([u8arr], `${fileName}.${suffix}`, {
            type: type
        })
        // å°†Fileæ–‡ä»¶å¯¹è±¡è¿”å›ç»™æ–¹æ³•çš„è°ƒç”¨è€…
        return file
        },
        stopNavigator() {
            navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
            const videoElement = this.$refs.videoElement;
            videoElement.srcObject = stream;
            videoElement.srcObject.getTracks()[0].stop()
            console.log("æ‘„åƒå¤´å…³é—­äº†")
          })
        },
        startRecord() {
			console.log("start to record now.");
            this.$message.success("æ­£åœ¨å½•éŸ³...")
			let self = this;
			self.isFinished = false;
			self.recorder.startRecord({
				success: res => {
					console.log("start record successfully123.");
				},
				error: res => {
					console.log("start record failed.");
				}
			});
		},
		stopRecord() {
			console.log("stop record now.");
			let self = this;
			self.isFinished = false;
			self.recorder.stopRecord({
				success: res => {
					//æ­¤å¤„å¯ä»¥è·å–éŸ³é¢‘æºæ–‡ä»¶(res)ï¼Œç”¨äºä¸Šä¼ ç­‰æ“ä½œ
					console.log("res---",res)
					console.log("res---",res.size)
					console.log("res---",res.type)

					console.log("++++++å¼€å§‹ä¸Šä¼ ")
					var form = new FormData;
					form.append("file",res,"1.mp3"); 
					var xhr=new XMLHttpRequest();
					// xhr.open("POST","http://localhost:9090/file/uploadImg");
                    xhr.open("POST","http://localhost:8000/query");
					xhr.onreadystatechange=function(){
					if(xhr.readyState==4){
					alert(xhr.status==200?"ä¸Šä¼ æˆåŠŸ":"æµ‹è¯•è¯·å…ˆæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œç„¶åé‡æ–°å½•éŸ³ï¼Œåœ¨networké€‰é¡¹å¡é‡Œé¢å°±èƒ½çœ‹åˆ°ä¸Šä¼ è¯·æ±‚æ•°æ®å’Œæ ¼å¼äº†");
				}}
					xhr.send(form);
				},
				error: res => {
					console.log("stop record failed.");
				}
			});
            self.recorder.stop();
		},
        handlenext() {
            document.querySelector("#TrainingResults").click();
        },
        
    },
    created() 
    {
        this.msg=this.voiceMsg
        this.$ws.addEventListener('message', (event) => {
        // å¤„ç† WebSocket æ¶ˆæ¯
        const message = event.data;
        console.log('WebSocketæ¶ˆæ¯ï¼š', message);
        
        if (message === '1') {
            this.selected(0);
        } else if (message === '2') {
            this.selected(1);
        } else if (message === '3') {
            this.selected(2);
        } else if (message === '4') {
            this.selected(3);
        } else if (message === '5') {
            this.selected(4);
        } else if (message === '6') {
            this.selected(5);
        } else if (message === '7') {
            this.selected(6);
        } else if (message === '8') {
            this.selected(7);
        } else if (message === '9') {
            this.selected(8);
        } else if (message === '10') {
            this.selected(9);
        } else if (message.includes('å‘ä¸Šæ»‘åŠ¨') && this.isactive >0) {
            this.selected(this.isactive-1);
        } else if (message.includes('å‘ä¸‹æ»‘åŠ¨') && this.isactive <9) {
            this.selected(this.isactive+1);
        } else if (message === 'gg') {
            this.playVedio();
        } 
        
        })
        

    },
    mounted() {
    }

}
</script>

<style lang="scss" scoped >
.ulStyle{
    list-style: none;
    cursor: pointer;
}
.ulStyle>li{
    text-align: center;
    line-height:7vh; 
    border: 1px solid red;
    margin-top: 30%;
    font-size: 3vh;
    height: 7vh;
    width:4vw;
    border: 2px solid #dcdfe6;
    color: #036eff;
    border-radius: 10%;
}
.isActive{
    background-color:#036eff;
    color: #ffffff !important;
    border: none !important;
}
.acTived,.acTivedTwo{
    pointer-events: none;
}
.msg{
    margin-left: 2%;
}
.showIcon{

}
.isShow,.isshow{
    display: none;
}
.el-card{
    --el-card-padding: 0;
}
.vedio{
    width: 90%;
    height: 70vh;
    margin-bottom: 4vh;
}
.isShowVedio{
    display: none;
}
.el-icon{
    margin-left: 2%;
}
</style>